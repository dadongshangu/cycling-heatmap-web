<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🚴 运动轨迹热力图生成器 - 支持骑行/徒步/跑步等GPS轨迹热力图生成</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/style.css">
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🚴</text></svg>">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <h1>🚴 运动轨迹热力图生成器</h1>
            <p class="subtitle">支持骑行、徒步、跑步等GPS轨迹热力图生成</p>
        </header>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Left Panel -->
            <div class="left-panel">
                <!-- File Upload Area -->
                <div class="upload-section">
                    <h3>📁 上传轨迹记录（GPX/FIT）</h3>
                    <div class="upload-area" id="uploadArea">
                        <div class="upload-content">
                            <div class="upload-icon">📁</div>
                            <p class="upload-text">拖拽轨迹记录到这里</p>
                            <p class="upload-subtext">支持 GPX 和 FIT 格式</p>
                            <input type="file" id="fileInput" multiple accept=".gpx,.GPX,.fit,.FIT" style="display: none;">
                            <button class="upload-btn" id="selectFileBtn">
                                选择文件
                            </button>
                            <button class="help-btn" id="gpxGuideBtn" onclick="showGpxGuide()">
                                📖 如何获取轨迹记录GPX？
                            </button>
                        </div>
                    </div>
                    
                    <!-- File List -->
                    <div class="file-list" id="fileList" style="display: none;">
                        <div class="file-list-header">
                            <h4>已加载的文件:</h4>
                            <button class="clear-btn" id="clearFiles">清除所有</button>
                        </div>
                        <details class="file-dropdown">
                            <summary class="file-summary" id="fileSummary">
                                <span id="fileCountText">0 个文件</span>
                                <span class="dropdown-arrow">▼</span>
                            </summary>
                            <div class="file-dropdown-content">
                                <ul id="fileListItems"></ul>
                            </div>
                        </details>
                    </div>
                </div>

                <!-- Generate Button Section -->
                <div class="generate-section">
                    <button class="generate-btn-large" id="generateBtn" disabled>
                        🗺️ 生成热力图
                    </button>
                    <p class="generate-hint">上传轨迹记录（GPX/FIT）后点击生成</p>
                </div>

                <!-- Controls Panel -->
                <div class="controls-section">
                    <details class="params-details">
                        <summary class="params-summary">
                            <span>⚙️ 参数设置</span>
                            <span class="dropdown-arrow">▼</span>
                        </summary>
                        <div class="params-content">
                            <!-- Map Style -->
                            <div class="control-group">
                                <label for="mapStyle">地图样式:</label>
                                <select id="mapStyle">
                                    <option value="dark">暗色地图 (推荐)</option>
                                    <option value="light">浅色地图</option>
                                </select>
                            </div>

                            <!-- Map Language -->
                            <div class="control-group">
                                <label for="mapLanguage">地图语言:</label>
                                <select id="mapLanguage">
                                    <option value="en" selected>English Map (CartoDB)</option>
                                    <option value="zh-vector">中文地图 (天地图矢量)</option>
                                    <option value="zh-satellite">中文卫星图 (天地图影像)</option>
                                </select>
                            </div>

                            <!-- Date Range -->
                            <div class="control-group">
                                <label for="dateRange">时间范围:</label>
                                <select id="dateRange">
                                    <option value="30">最近30天</option>
                                    <option value="90">最近3个月</option>
                                    <option value="180">最近6个月</option>
                                    <option value="365" selected>最近1年</option>
                                    <option value="0">所有时间</option>
                                </select>
                            </div>

                            <!-- Advanced Parameters Separator -->
                            <div class="control-group" style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #e9ecef;">
                                <label style="font-weight: 600; color: #495057;">🎨 高级参数</label>
                            </div>

                            <!-- Radius -->
                            <div class="control-group">
                                <label for="radius">线条粗细: <span id="radiusValue">1</span></label>
                                <input type="range" id="radius" min="1" max="10" value="1" step="1">
                            </div>

                            <!-- Blur -->
                            <div class="control-group">
                                <label for="blur">模糊程度: <span id="blurValue">1</span></label>
                                <input type="range" id="blur" min="1" max="20" value="1" step="1">
                            </div>

                            <!-- Opacity -->
                            <div class="control-group">
                                <label for="opacity">透明度: <span id="opacityValue">0.8</span></label>
                                <input type="range" id="opacity" min="0.1" max="1.0" value="0.8" step="0.1">
                            </div>

                            <!-- API Settings Link -->
                            <div class="control-group" style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #e9ecef;">
                                <a href="#" onclick="window.app.showApiKeyConfig(); return false;" class="api-settings-link">
                                    ⚙️ API设置（可选，用于中文地图）
                                </a>
                            </div>
                        </div>
                    </details>
                </div>

                <!-- Statistics -->
                <div class="stats-section" id="statsSection" style="display: none;">
                    <h3>📊 统计信息</h3>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <span class="stat-label">文件数量:</span>
                            <span class="stat-value" id="fileCount">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">轨迹点数:</span>
                            <span class="stat-value" id="pointCount">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">日期范围:</span>
                            <span class="stat-value" id="dateRangeText">-</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">总里程:</span>
                            <span class="stat-value" id="totalDistance">0 km</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Panel - Map -->
            <div class="right-panel">
                <div class="map-container">
                    <div id="map" class="map"></div>
                    
                    <!-- Loading Overlay -->
                    <div class="loading-overlay" id="loadingOverlay" style="display: none;">
                        <div class="loading-content">
                            <div class="spinner"></div>
                            <p id="loadingText">正在处理文件...</p>
                            <div class="progress-bar">
                                <div class="progress-fill" id="progressFill"></div>
                            </div>
                        </div>
                    </div>

                    <!-- API Usage Panel -->
                    <div class="api-usage-panel" id="apiUsagePanel">
                        <div class="usage-item">
                            <span class="usage-label">矢量底图:</span>
                            <span class="usage-count" id="vectorCount">0</span>
                            <span class="usage-limit">/ 10,000</span>
                            <div class="usage-bar">
                                <div class="usage-fill normal" id="vectorBar"></div>
                            </div>
                        </div>
                        <div class="usage-item">
                            <span class="usage-label">中文标注:</span>
                            <span class="usage-count" id="labelCount">0</span>
                            <span class="usage-limit">/ 10,000</span>
                            <div class="usage-bar">
                                <div class="usage-fill normal" id="labelBar"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Map Type Indicator -->
                    <div class="map-type-indicator english-map" id="mapTypeIndicator">
                        🇬🇧 英文地图 (CartoDB)
                    </div>

                    <!-- Map Controls -->
                    <div class="map-controls">
                        <button class="map-control-btn map-control-btn-primary" id="exportBtn" title="导出热力图为PNG" disabled>
                            📷 导出热力图
                        </button>
                        <button class="map-control-btn map-control-btn-secondary" id="generateVideoBtn" title="生成增长视频" disabled>
                            🎬 视频
                        </button>
                        <button class="map-control-btn map-control-btn-secondary" id="checkVideoBtn" title="检查已完成的视频">
                            ✅ 检查视频
                        </button>
                        <button class="map-control-btn" id="fullscreenBtn" title="全屏显示">
                            🔍 全屏
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="footer">
            <p>
                💡 提示: 所有文件都在浏览器本地处理，不会上传到服务器 | 
                <a href="https://dadongshangu.github.io" target="_blank">开发者</a> | 
                <a href="#" onclick="showHelp()">使用帮助</a> | 
                <a href="#" onclick="showDonate()">☕ 支持项目</a>
            </p>
        </footer>
    </div>

    <!-- Help Modal -->
    <div class="modal" id="helpModal" style="display: none;">
        <div class="modal-content">
            <span class="close" onclick="closeHelp()">&times;</span>
            <h2>📖 使用帮助</h2>
            <div class="help-content">
                <h3>🚀 快速开始</h3>
                <ol>
                    <li>拖拽或选择轨迹记录（GPX 或 FIT）上传</li>
                    <li>调整参数设置（可选）</li>
                    <li>点击"生成热力图"按钮</li>
                    <li>在地图上查看结果</li>
                </ol>

                <h3>⚙️ 参数说明</h3>
                <ul>
                    <li><strong>地图样式:</strong> 选择暗色或浅色背景</li>
                    <li><strong>线条粗细:</strong> 数值越大线条越粗</li>
                    <li><strong>模糊程度:</strong> 数值越大越模糊</li>
                    <li><strong>透明度:</strong> 热力图的透明度</li>
                    <li><strong>时间范围:</strong> 只显示指定时间内的轨迹</li>
                </ul>

                <h3>📁 支持的文件格式</h3>
                <ul>
                    <li>轨迹记录GPX (.gpx) - GPS Exchange Format</li>
                    <li>轨迹记录FIT (.fit) - Garmin 等码表常用格式</li>
                    <li>支持批量上传多个文件（可混合 GPX 和 FIT 格式）</li>
                    <li>支持骑行、徒步、跑步等所有GPS轨迹</li>
                </ul>

                <h3>🎨 Strava风格</h3>
                <p>热力图使用绿→黄→红的渐变色，频繁经过的路线会显示为红色。</p>

                <h3>📞 联系开发者</h3>
                <div style="background: #e7f3ff; padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 4px solid #17a2b8;">
                    <p style="margin: 0 0 15px 0; color: #495057; line-height: 1.6;">
                        如果您在使用过程中遇到问题，或者需要帮助（如借用API密钥等），欢迎联系开发者：
                    </p>
                    <div style="text-align: center;">
                        <div style="background: white; padding: 20px; border-radius: 8px; display: inline-block; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                            <p style="margin: 0; color: #495057; font-size: 1.2rem; font-weight: 600; letter-spacing: 2px;">
                                📱 微信号：<span style="color: #17a2b8; font-size: 1.4rem;">ddvalley</span>
                            </p>
                        </div>
                        <p style="margin: 10px 0 0 0; color: #495057; font-size: 0.9rem; font-weight: 500;">
                            添加微信联系开发者
                        </p>
                    </div>
                    <p style="margin: 15px 0 0 0; color: #6c757d; font-size: 0.85rem; line-height: 1.6;">
                        💡 提示：开发者可以帮助您解决使用问题，或者提供API密钥借用服务。
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- GPX Guide Modal -->
    <div class="modal" id="gpxGuideModal" style="display: none;">
        <div class="modal-content large-modal">
            <span class="close" onclick="closeGpxGuide()">&times;</span>
            <h2>📖 如何获取轨迹记录GPX？</h2>
            <div class="guide-content">
                <!-- 搜索框 -->
                <div class="search-box">
                    <input type="text" id="guideSearch" placeholder="🔍 搜索你的设备或应用..." onkeyup="filterGuide()">
                </div>

                <!-- Strava（推荐） -->
                <div class="guide-section" data-keywords="strava 斯特拉瓦 码表同步 批量导出 免费版">
                    <h3>📱 Strava（推荐）</h3>
                    
                    <div class="device-item">
                        <p style="background: #e7f3ff; padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 4px solid #17a2b8; color: #495057; line-height: 1.6;">
                            <strong>💡 为什么推荐Strava？</strong><br>
                            大部分码表（包括迈金、iGPSPORT、Garmin、Wahoo等）都支持将轨迹自动同步到Strava，即使是免费版Strava也完全支持此功能。通过Strava可以方便地批量导出所有历史轨迹记录。
                        </p>
                        
                        <h5>📥 单个活动导出</h5>
                        <ol>
                            <li>打开Strava网站（<a href="https://www.strava.com" target="_blank">www.strava.com</a>）并登录</li>
                            <li>进入要导出的活动详情页</li>
                            <li>点击右上角"..."菜单</li>
                            <li>选择"导出GPX"即可下载单个活动的GPX文件</li>
                        </ol>
                        
                        <h5>📦 批量导出所有轨迹（推荐）</h5>
                        <p><strong>此方法可以一次性下载所有历史轨迹记录，非常适合需要导出大量轨迹的用户。</strong></p>
                        <ol>
                            <li><strong>进入删除账户页面：</strong>
                                <ul>
                                    <li>访问 <a href="https://www.strava.com/athlete/delete_your_account" target="_blank">https://www.strava.com/athlete/delete_your_account</a></li>
                                    <li>⚠️ <strong>注意：</strong>这只是进入数据导出页面，<strong>不会真的删除您的账户</strong></li>
                                </ul>
                            </li>
                            <li><strong>请求数据导出：</strong>
                                <ul>
                                    <li>在页面中找到"下载或删除你的账户"选项</li>
                                    <li>点击"请求数据导出"</li>
                                    <li>Strava会开始准备您的所有数据（包括所有轨迹记录）</li>
                                </ul>
                            </li>
                            <li><strong>接收邮件：</strong>
                                <ul>
                                    <li>Strava会在1-2天内通过邮件发送下载链接</li>
                                    <li>检查您的注册邮箱，找到Strava发送的邮件</li>
                                    <li>点击邮件中的下载链接</li>
                                </ul>
                            </li>
                            <li><strong>下载并解压缩：</strong>
                                <ul>
                                    <li>下载的文件是一个压缩包，包含所有轨迹记录</li>
                                    <li>解压缩后，您会看到很多 <code>*.fit.gz</code> 格式的文件</li>
                                    <li>这些是GZIP压缩的FIT格式文件，需要再次解压缩</li>
                                </ul>
                            </li>
                            <li><strong>批量解压缩.fit.gz文件：</strong>
                                <ul>
                                    <li><strong>Windows用户：</strong>可以使用7-Zip、WinRAR等工具批量解压缩</li>
                                    <li><strong>Mac用户：</strong>可以使用The Unarchiver或命令行工具批量解压缩</li>
                                    <li><strong>Linux用户：</strong>可以使用 <code>gunzip *.fit.gz</code> 命令批量解压缩</li>
                                    <li>解压缩后会得到 <code>*.fit</code> 格式的文件</li>
                                </ul>
                            </li>
                            <li><strong>上传到本应用：</strong>
                                <ul>
                                    <li>本应用支持直接上传 <code>.fit</code> 格式文件，无需转换为GPX</li>
                                    <li>也可以使用在线工具将 <code>.fit</code> 转换为 <code>.gpx</code> 格式</li>
                                </ul>
                            </li>
                        </ol>
                        <p style="background: #fff3cd; padding: 10px; border-radius: 8px; margin: 10px 0; border-left: 4px solid #ffc107; color: #856404; font-size: 0.9em;">
                            ⚠️ <strong>重要提示：</strong>批量导出功能不会删除您的Strava账户，只是下载您的数据。如果您只是想导出轨迹，完全不用担心账户安全问题。
                        </p>
                    </div>
                </div>

                <!-- 码表设备 -->
                <div class="guide-section" data-keywords="码表 迈金 meilan igpsport garmin wahoo bryton 顽鹿竞技">
                    <h3>🚴 码表设备</h3>
                    
                    <div class="device-group">
                        <h4>🇨🇳 国产码表品牌</h4>
                        
                        <div class="device-item">
                            <h5>📱 迈金码表 (MEILAN)</h5>
                            <p><strong>对应App:</strong> 顽鹿竞技</p>
                            <ol>
                                <li>确保码表数据已通过蓝牙同步到顽鹿竞技App</li>
                                <li>打开顽鹿竞技App，进入"活动记录"</li>
                                <li>选择要导出的骑行活动</li>
                                <li>点击"分享"或"导出"按钮</li>
                                <li>选择"GPX格式"进行导出</li>
                                <li>保存到手机或直接分享到电脑</li>
                            </ol>
                        </div>

                        <div class="device-item">
                            <h5>📱 iGPSPORT码表</h5>
                            <p><strong>对应App:</strong> iGPSPORT官方App</p>
                            <ol>
                                <li>打开iGPSPORT App，同步码表数据</li>
                                <li>在"历史记录"中找到要导出的活动</li>
                                <li>点击活动详情页面</li>
                                <li>选择"导出"→"GPX格式"</li>
                                <li>也可以同步到Strava后再导出</li>
                            </ol>
                        </div>

                        <div class="device-item">
                            <h5>📱 其他国产码表</h5>
                            <ul>
                                <li><strong>猫眼(CatEye):</strong> 使用CatEye Cycling App导出</li>
                                <li><strong>速腾(XOSS):</strong> 使用XOSS App导出</li>
                                <li><strong>百锐腾(Bryton):</strong> 使用Bryton Active App导出</li>
                            </ul>
                        </div>
                    </div>

                    <div class="device-group">
                        <h4>🌍 国际品牌码表</h4>
                        
                        <div class="device-item">
                            <h5>📱 Garmin码表 (Edge系列)</h5>
                            <ol>
                                <li><strong>方法1 - Garmin Connect:</strong>
                                    <ul>
                                        <li>打开Garmin Connect网站或App</li>
                                        <li>找到要导出的活动</li>
                                        <li>点击"导出原始数据"</li>
                                        <li>选择GPX格式下载</li>
                                    </ul>
                                </li>
                                <li><strong>方法2 - USB直连:</strong>
                                    <ul>
                                        <li>用USB线连接码表到电脑</li>
                                        <li>在Garmin/Activities文件夹中找到.fit文件</li>
                                        <li>使用在线工具转换为GPX格式</li>
                                    </ul>
                                </li>
                            </ol>
                        </div>

                        <div class="device-item">
                            <h5>📱 Wahoo码表 (ELEMNT系列)</h5>
                            <ol>
                                <li>打开Wahoo ELEMNT App</li>
                                <li>在"历史记录"中选择活动</li>
                                <li>点击"分享"按钮</li>
                                <li>选择"导出GPX"</li>
                                <li>也可以同步到Strava后导出</li>
                            </ol>
                        </div>
                    </div>
                </div>

                <!-- 智能手表 -->
                <div class="guide-section" data-keywords="手表 apple watch garmin 华为 小米 运动手表">
                    <h3>⌚ 智能手表</h3>
                    
                    <div class="device-item">
                        <h5>📱 Apple Watch</h5>
                        <ol>
                            <li><strong>通过第三方App:</strong>
                                <ul>
                                    <li>使用Strava、WorkOutDoors等App记录</li>
                                    <li>在对应App中导出GPX</li>
                                </ul>
                            </li>
                            <li><strong>通过健康App:</strong>
                                <ul>
                                    <li>健康App → 浏览 → 活动</li>
                                    <li>选择"体能训练"</li>
                                    <li>导出健康数据（需要第三方工具转换）</li>
                                </ul>
                            </li>
                        </ol>
                    </div>

                    <div class="device-item">
                        <h5>📱 Garmin手表</h5>
                        <ol>
                            <li>同Garmin码表，使用Garmin Connect导出</li>
                            <li>在Garmin Connect中找到手表记录的活动</li>
                            <li>导出为GPX格式</li>
                        </ol>
                    </div>

                    <div class="device-item">
                        <h5>📱 华为/小米手表</h5>
                        <ol>
                            <li>打开对应的运动健康App</li>
                            <li>找到运动记录</li>
                            <li>查看是否有导出功能</li>
                            <li>或同步到第三方平台后导出</li>
                        </ol>
                    </div>
                </div>

                <!-- 手机应用 -->
                <div class="guide-section" data-keywords="手机 app 骑记 行者 咕咚 keep 顽鹿竞技 两步路 六只脚 户外助手 悦跑圈 徒步 跑步">
                    <h3>📱 手机应用</h3>
                    
                    <div class="device-group">
                        <h4>🌍 国际应用</h4>
                        
                        <div class="device-item">
                            <h5>📱 Komoot / MapMyRide</h5>
                            <ol>
                                <li>登录对应网站</li>
                                <li>找到活动记录</li>
                                <li>查找导出或下载选项</li>
                                <li>选择GPX格式</li>
                            </ol>
                        </div>
                    </div>

                    <div class="device-group">
                        <h4>🇨🇳 国内应用</h4>
                        
                        <div class="device-item">
                            <h5>📱 顽鹿竞技</h5>
                            <ol>
                                <li>打开顽鹿竞技App</li>
                                <li>进入"活动记录"</li>
                                <li>选择要导出的骑行</li>
                                <li>点击"分享"或"导出"</li>
                                <li>选择GPX格式</li>
                            </ol>
                        </div>

                        <div class="device-item">
                            <h5>📱 骑记 / 行者 / 咕咚</h5>
                            <ol>
                                <li>打开对应App</li>
                                <li>找到运动记录</li>
                                <li>查看是否有"导出"或"分享"功能</li>
                                <li>部分App可能需要会员才能导出</li>
                                <li>也可以尝试同步到Strava后导出</li>
                            </ol>
                        </div>

                        <div class="device-item">
                            <h5>🏔️ 两步路（户外助手）</h5>
                            <ol>
                                <li>打开两步路App</li>
                                <li>进入"我的" → "轨迹记录"</li>
                                <li>选择要导出的轨迹</li>
                                <li>点击轨迹详情页右上角"..."菜单</li>
                                <li>选择"导出" → "GPX格式"</li>
                                <li>也可以通过网页版（www.2bulu.com）登录后导出</li>
                            </ol>
                        </div>

                        <div class="device-item">
                            <h5>🏔️ 六只脚</h5>
                            <ol>
                                <li>打开六只脚App</li>
                                <li>进入"我的" → "我的轨迹"</li>
                                <li>选择要导出的轨迹</li>
                                <li>点击轨迹详情页</li>
                                <li>点击"分享"或"导出"按钮</li>
                                <li>选择"GPX格式"导出</li>
                                <li>也可以通过网页版（www.foooooot.com）导出</li>
                            </ol>
                        </div>

                        <div class="device-item">
                            <h5>🏃 悦跑圈 / Keep</h5>
                            <ol>
                                <li>打开对应App</li>
                                <li>进入"我的" → "运动记录"或"跑步记录"</li>
                                <li>选择要导出的活动</li>
                                <li>查看是否有"导出"或"分享"功能</li>
                                <li>部分App可能需要会员才能导出GPX</li>
                                <li>也可以尝试同步到Strava后导出</li>
                            </ol>
                        </div>
                    </div>
                </div>

                <!-- 其他来源 -->
                <div class="guide-section" data-keywords="室内 zwift trainer 行车记录仪">
                    <h3>🏠 其他来源</h3>
                    
                    <div class="device-item">
                        <h5>📱 室内骑行台 (Zwift, TrainerRoad)</h5>
                        <ol>
                            <li>完成室内骑行后</li>
                            <li>在对应平台找到活动记录</li>
                            <li>导出为GPX格式</li>
                            <li>或同步到Strava后导出</li>
                        </ol>
                    </div>

                    <div class="device-item">
                        <h5>📱 汽车行车记录仪</h5>
                        <ol>
                            <li>部分高端行车记录仪支持GPS轨迹记录</li>
                            <li>查看设备说明书</li>
                            <li>通过配套软件导出轨迹</li>
                        </ol>
                    </div>
                </div>

                <!-- 常见问题 -->
                <div class="guide-section">
                    <h3>❓ 常见问题</h3>
                    
                    <div class="faq-item">
                        <h5>Q: 我的设备只能导出.fit文件，怎么办？</h5>
                        <p>A: 可以使用在线转换工具，如GPSies、GPS Visualizer等，将.fit文件转换为GPX格式。</p>
                    </div>

                    <div class="faq-item">
                        <h5>Q: 为什么我的App没有导出功能？</h5>
                        <p>A: 部分App可能需要付费会员才能导出，或者可以先同步到Strava等平台再导出。</p>
                    </div>

                    <div class="faq-item">
                        <h5>Q: 轨迹记录GPX很大，上传很慢怎么办？</h5>
                        <p>A: 可以使用GPX编辑工具简化轨迹点，或者分批上传多个小文件。</p>
                    </div>

                    <div class="faq-item">
                        <h5>Q: 我的迈金码表应该用什么App？</h5>
                        <p>A: 迈金(MEILAN)码表对应的官方App是"顽鹿竞技"。</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Donate Modal -->
    <div class="modal" id="donateModal" style="display: none;">
        <div class="modal-content donate-modal">
            <span class="close" onclick="closeDonate()">&times;</span>
            <h2>☕ 支持项目开发</h2>
            <div class="donate-content">
                <div class="donate-intro">
                    <p>🚴‍♂️ 如果这个运动轨迹热力图工具对您有帮助，欢迎请作者喝杯咖啡！</p>
                    <p>您的支持是项目持续发展的动力 💪</p>
                </div>
                
                <div class="donate-qr-section">
                    <h3>💝 微信赞赏</h3>
                    <div class="qr-container">
                        <img src="donate.JPEG" alt="微信赞赏码" class="donate-qr" />
                        <p class="qr-instruction">使用微信扫描上方二维码即可赞赏</p>
                    </div>
                </div>
                
                <div class="donate-thanks">
                    <p>🙏 感谢您的支持与鼓励！</p>
                    <p>每一份支持都会让这个项目变得更好 ✨</p>
                </div>
            </div>
        </div>
    </div>

    <!-- API Key Prompt Modal -->
    <div class="modal" id="apiKeyPromptModal" style="display: none;">
        <div class="modal-content">
            <span class="close" onclick="window.app.closeApiKeyPrompt()">&times;</span>
            <h2>💡 中文地图需要API密钥</h2>
            <div class="api-key-prompt-content">
                <p style="margin-bottom: 15px; line-height: 1.6;">
                    <strong>中文地图是可选的高级功能。</strong><br>
                    英文地图完全免费，功能相同，无需任何配置即可使用！
                </p>
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <p style="margin: 0; color: #6c757d; font-size: 0.9rem;">
                        💡 提示：如果您想使用中文地图，需要配置天地图API密钥。<br>
                        这是可选功能，不影响核心功能的使用。
                    </p>
                </div>
                <div style="display: flex; gap: 10px; justify-content: center;">
                    <button class="upload-btn" onclick="window.app.showApiKeyConfig(); window.app.closeApiKeyPrompt();" style="flex: 1;">
                        了解如何获取密钥
                    </button>
                    <button class="help-btn" onclick="window.app.closeApiKeyPrompt()" style="flex: 1; background: #6c757d;">
                        继续使用英文地图
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- API Key Config Modal -->
    <div class="modal" id="apiKeyConfigModal" style="display: none;">
        <div class="modal-content">
            <span class="close" onclick="window.app.closeApiKeyConfig()">&times;</span>
            <h2>⚙️ API密钥设置（可选）</h2>
            <div class="api-key-config-content">
                <p style="margin-bottom: 15px; line-height: 1.6; color: #6c757d;">
                    这是可选功能，用于使用中文地图。英文地图完全免费，无需配置即可使用所有核心功能。
                </p>
                
                <div class="control-group" style="margin-bottom: 20px;">
                    <label for="apiKeyInput">天地图API密钥:</label>
                    <input type="text" id="apiKeyInput" placeholder="请输入您的天地图API密钥" 
                           style="width: 100%; padding: 10px; border: 1px solid #dee2e6; border-radius: 6px; font-size: 0.9rem;">
                </div>

                <div style="background: #e7f3ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #17a2b8;">
                    <h4 style="margin: 0 0 10px 0; color: #495057; font-size: 1rem;">如何获取天地图API密钥？</h4>
                    <ol style="margin: 0; padding-left: 20px; color: #6c757d; font-size: 0.9rem; line-height: 1.8;">
                        <li>访问 <a href="http://lbs.tianditu.gov.cn/" target="_blank" style="color: #17a2b8;">天地图官网</a></li>
                        <li>注册账号并登录</li>
                        <li>进入控制台，创建应用</li>
                        <li>获取API密钥（Key）</li>
                        <li>将密钥粘贴到上方输入框并保存</li>
                    </ol>
                    <p style="margin: 10px 0 0 0; color: #6c757d; font-size: 0.85rem;">
                        ⚠️ 注意：个人开发者每日有10,000次免费调用限制
                    </p>
                </div>

                <!-- 联系开发者借用密钥 -->
                <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #ffc107;">
                    <h4 style="margin: 0 0 15px 0; color: #856404; font-size: 1rem;">💬 或者联系开发者借用密钥</h4>
                    <div style="text-align: center; margin-bottom: 15px;">
                        <div style="background: white; padding: 20px; border-radius: 8px; display: inline-block; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                            <p style="margin: 0; color: #856404; font-size: 1.2rem; font-weight: 600; letter-spacing: 2px;">
                                📱 微信号：<span style="color: #17a2b8; font-size: 1.4rem;">ddvalley</span>
                            </p>
                        </div>
                        <p style="margin: 10px 0 0 0; color: #856404; font-size: 0.9rem; font-weight: 500;">
                            添加微信联系开发者，可以借用API密钥使用
                        </p>
                    </div>
                    <p style="margin: 0; color: #856404; font-size: 0.85rem; line-height: 1.6;">
                        💡 提示：如果您暂时无法申请自己的API密钥，可以联系开发者借用。开发者会提供共享的API密钥供您使用。
                    </p>
                </div>

                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <button class="upload-btn" onclick="window.app.saveApiKey()" style="flex: 1;">
                        保存密钥
                    </button>
                    <button class="help-btn" onclick="window.app.closeApiKeyConfig()" style="flex: 1; background: #6c757d;">
                        取消
                    </button>
                </div>

                <!-- 书签生成器 -->
                <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border-left: 4px solid #ffc107; margin-top: 20px;">
                    <h4 style="margin: 0 0 10px 0; color: #495057; font-size: 1rem;">🚀 快速设置书签（推荐）</h4>
                    <p style="margin: 0 0 15px 0; color: #6c757d; font-size: 0.9rem; line-height: 1.6;">
                        生成一个浏览器书签，点击一次即可自动设置API密钥，方便重复使用！
                    </p>
                    <div id="bookmarkletContainer" style="display: none;">
                        <div style="background: white; padding: 12px; border-radius: 6px; margin-bottom: 10px; border: 1px solid #dee2e6;">
                            <p style="margin: 0 0 8px 0; font-size: 0.85rem; color: #6c757d; font-weight: 600;">📌 拖拽下面的链接到浏览器书签栏：</p>
                            <a href="#" id="bookmarkletLink" 
                               style="display: inline-block; padding: 8px 12px; background: #17a2b8; color: white; text-decoration: none; border-radius: 4px; font-size: 0.85rem; word-break: break-all; cursor: move;">
                                🔑 设置API密钥
                            </a>
                        </div>
                        <div style="background: #e7f3ff; padding: 10px; border-radius: 6px; margin-bottom: 10px;">
                            <p style="margin: 0; font-size: 0.8rem; color: #004085; line-height: 1.5;">
                                <strong>使用说明：</strong><br>
                                1. 将上方链接拖拽到浏览器书签栏<br>
                                2. 每次访问此页面时，点击书签即可自动设置密钥<br>
                                3. 密钥保存在浏览器本地，不会上传到服务器
                            </p>
                        </div>
                        <p style="margin: 0; font-size: 0.75rem; color: #856404;">
                            ⚠️ 注意：书签包含您的API密钥，请妥善保管，不要分享给他人
                        </p>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="help-btn" onclick="window.app.generateBookmarklet()" 
                                style="flex: 1; background: #ffc107; color: #856404; border: none;">
                            🔖 生成自动设置书签
                        </button>
                        <button class="help-btn" onclick="window.app.showInputBookmarklet()" 
                                style="flex: 1; background: #17a2b8; color: white; border: none;">
                            📝 生成输入式书签
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile File Selection Help Modal -->
    <div class="modal" id="mobileFileHelpModal" style="display: none;">
        <div class="modal-content">
            <span class="close" onclick="window.app.closeMobileFileHelp()">&times;</span>
            <h2>📱 移动端文件选择帮助</h2>
            <div class="screenshot-guide-content">
                <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border-left: 4px solid #ffc107; margin-bottom: 20px;">
                    <p style="margin: 0; color: #856404; font-weight: 500;">
                        ⚠️ 如果文件显示为灰色无法选择，请按照以下步骤操作
                    </p>
                </div>

                <div class="device-guide-section">
                    <h3>🍎 iOS设备（iPhone/iPad）</h3>
                    <ol style="line-height: 1.8;">
                        <li><strong>方法1 - 使用"文件"App：</strong>
                            <ul style="margin-top: 8px; padding-left: 20px;">
                                <li>打开"文件"App</li>
                                <li>找到你的GPX文件（在"下载项"或"iCloud云盘"中）</li>
                                <li>长按文件，选择"共享"</li>
                                <li>选择"Safari"或"浏览器"打开</li>
                                <li>在浏览器中打开后，再使用本工具选择文件</li>
                            </ul>
                        </li>
                        <li><strong>方法2 - 先下载到本地：</strong>
                            <ul style="margin-top: 8px; padding-left: 20px;">
                                <li>如果文件在云存储中，先下载到"文件"App的本地存储</li>
                                <li>在"文件"App中，长按文件 → "移动" → 选择"我的iPhone"或"下载项"</li>
                                <li>确保文件已完全下载（不是云存储图标）</li>
                                <li>然后再尝试选择文件</li>
                            </ul>
                        </li>
                        <li><strong>方法3 - 使用其他App：</strong>
                            <ul style="margin-top: 8px; padding-left: 20px;">
                                <li>如果文件在邮件或消息中，先保存到"文件"App</li>
                                <li>或者使用支持文件分享的App（如"文件"、"文件管理器"等）</li>
                            </ul>
                        </li>
                    </ol>
                </div>

                <div class="device-guide-section">
                    <h3>🤖 Android设备</h3>
                    <ol style="line-height: 1.8;">
                        <li><strong>方法1 - 使用文件管理器：</strong>
                            <ul style="margin-top: 8px; padding-left: 20px;">
                                <li>打开"文件"或"文件管理器"App</li>
                                <li>找到你的GPX文件（通常在"下载"文件夹中）</li>
                                <li>长按文件，选择"打开方式"</li>
                                <li>选择浏览器（Chrome、Edge等）</li>
                                <li>在浏览器中打开后，再使用本工具选择文件</li>
                            </ul>
                        </li>
                        <li><strong>方法2 - 确保文件已下载：</strong>
                            <ul style="margin-top: 8px; padding-left: 20px;">
                                <li>如果文件在云存储中，先确保已完全下载到本地</li>
                                <li>在文件管理器中，找到文件并确认可以正常打开</li>
                                <li>然后再尝试选择文件</li>
                            </ul>
                        </li>
                        <li><strong>方法3 - 检查存储权限：</strong>
                            <ul style="margin-top: 8px; padding-left: 20px;">
                                <li>在系统设置中，确保浏览器有文件访问权限</li>
                                <li>设置 → 应用 → 浏览器 → 权限 → 存储（允许）</li>
                            </ul>
                        </li>
                    </ol>
                </div>

                <div style="background: #e7f3ff; padding: 15px; border-radius: 8px; margin-top: 20px;">
                    <p style="margin: 0; color: #004085; line-height: 1.6;">
                        <strong>💡 通用提示：</strong><br>
                        • 确保GPX文件已完全下载到本地，不是云存储中的占位符<br>
                        • 如果文件在云存储中，先下载到本地再选择<br>
                        • 尝试使用不同的文件管理器或浏览器<br>
                        • 确保文件扩展名是 .gpx 或 .fit（不是 .gpx.txt 或其他）<br>
                        • 如果问题持续，可以尝试将文件通过邮件发送给自己，然后从邮件中保存
                    </p>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="upload-btn" onclick="window.app.closeMobileFileHelp()" style="flex: 1;">
                        我知道了
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Video Config Modal -->
    <div class="modal" id="videoConfigModal" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <span class="close" onclick="window.app.closeVideoConfigModal()">&times;</span>
            <h2>🎬 生成热力图增长视频</h2>
            <div style="padding: 20px 0;">
                <p style="margin-bottom: 20px; color: #6c757d; line-height: 1.6;">
                    生成展示轨迹随时间逐渐点亮过程的视频。选择时间范围后，系统会自动选择合适的时间粒度。
                </p>

                <div class="control-group" style="margin-bottom: 20px;">
                    <label for="videoStartDate" style="display: block; margin-bottom: 8px; font-weight: 500;">
                        开始时间：
                    </label>
                    <input type="date" id="videoStartDate" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </div>

                <div class="control-group" style="margin-bottom: 20px;">
                    <label for="videoEndDate" style="display: block; margin-bottom: 8px; font-weight: 500;">
                        结束时间：
                    </label>
                    <input type="date" id="videoEndDate" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </div>

                <div style="background: #fff3cd; padding: 12px; border-radius: 6px; margin-bottom: 20px; border-left: 4px solid #ffc107;">
                    <p style="margin: 0; color: #856404; font-size: 0.9rem; line-height: 1.5;">
                        ⚠️ <strong>注意：</strong>视频生成需要较长时间，特别是数据量较大时。建议在PC端使用，并确保网络连接稳定。
                    </p>
                </div>

                <div style="display: flex; gap: 10px;">
                    <button class="upload-btn" onclick="window.app.generateVideo()" style="flex: 1;">
                        开始生成
                    </button>
                    <button class="upload-btn" onclick="window.app.closeVideoConfigModal()" style="flex: 1; background: #6c757d;">
                        取消
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Video Progress Modal -->
    <div class="modal" id="videoProgressModal" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <h2>🎬 正在生成视频</h2>
            <div style="padding: 20px 0;">
                <div style="margin-bottom: 20px;">
                    <div style="background: #f0f0f0; border-radius: 10px; height: 30px; overflow: hidden; position: relative;">
                        <div id="videoProgressBar" style="background: #17a2b8; height: 100%; width: 0%; transition: width 0.3s ease; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.85rem; font-weight: 500;">
                        </div>
                    </div>
                    <p id="videoProgressText" style="text-align: center; margin-top: 10px; color: #6c757d;">
                        处理中...
                    </p>
                </div>

                <div style="display: flex; gap: 10px;">
                    <button class="upload-btn" onclick="window.app.cancelVideoGeneration()" style="flex: 1; background: #dc3545;">
                        取消生成
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Screenshot Guide Modal -->
    <div class="modal" id="screenshotGuideModal" style="display: none;">
        <div class="modal-content">
            <span class="close" onclick="window.app.closeScreenshotGuide()">&times;</span>
            <h2>📸 使用截屏保存热力图</h2>
            <div class="screenshot-guide-content">
                <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border-left: 4px solid #ffc107; margin-bottom: 20px;">
                    <p style="margin: 0; color: #856404; font-weight: 500;">
                        ⚠️ 移动端导出功能可能受限，建议使用截屏方式保存热力图
                    </p>
                </div>

                <div class="device-guide-section">
                    <h3>🍎 iOS设备（iPhone/iPad）</h3>
                    <ol style="line-height: 1.8;">
                        <li>确保热力图完整显示在屏幕上</li>
                        <li>同时按下<strong>电源键 + 音量上键</strong>（iPhone X及以后）</li>
                        <li>或同时按下<strong>电源键 + Home键</strong>（iPhone 8及以前）</li>
                        <li>截图会自动保存到相册</li>
                        <li>可以在相册中查看和分享</li>
                    </ol>
                </div>

                <div class="device-guide-section">
                    <h3>🤖 Android设备</h3>
                    <ol style="line-height: 1.8;">
                        <li>确保热力图完整显示在屏幕上</li>
                        <li>同时按下<strong>电源键 + 音量下键</strong></li>
                        <li>或从屏幕顶部下拉，点击<strong>截屏</strong>按钮</li>
                        <li>截图会自动保存到相册/图库</li>
                        <li>可以在图库中查看和分享</li>
                    </ol>
                </div>

                <div style="background: #e7f3ff; padding: 15px; border-radius: 8px; margin-top: 20px;">
                    <p style="margin: 0; color: #004085; line-height: 1.6;">
                        <strong>💡 提示：</strong><br>
                        • 截屏前可以点击"全屏"按钮，获得更好的显示效果<br>
                        • 截屏后可以在相册/图库中编辑和裁剪<br>
                        • 如果需要更高质量的图片，建议在桌面浏览器中使用导出功能
                    </p>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="upload-btn" onclick="window.app.closeScreenshotGuide()" style="flex: 1;">
                        我知道了
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        // 在页面加载前过滤浏览器跟踪防护警告（不影响功能，这些警告是浏览器安全机制）
        (function() {
            // 保存原始方法
            const originalWarn = console.warn;
            const originalError = console.error;
            const originalLog = console.log;
            
            // 重写 console.warn
            console.warn = function(...args) {
                const message = args.join(' ');
                if (message.includes('Tracking Prevention') || 
                    message.includes('blocked access to storage') ||
                    message.includes('TrackingPrevention')) {
                    // 静默忽略这些警告，它们不影响功能
                    return;
                }
                originalWarn.apply(console, args);
            };
            
            // 重写 console.error
            console.error = function(...args) {
                const message = args.join(' ');
                if (message.includes('Tracking Prevention') || 
                    message.includes('blocked access to storage') ||
                    message.includes('TrackingPrevention')) {
                    // 静默忽略这些错误，它们不影响功能
                    return;
                }
                originalError.apply(console, args);
            };
            
            // 也过滤 console.log 中的相关消息
            console.log = function(...args) {
                const message = args.join(' ');
                if (message.includes('Tracking Prevention') || 
                    message.includes('blocked access to storage') ||
                    message.includes('TrackingPrevention')) {
                    // 静默忽略
                    return;
                }
                originalLog.apply(console, args);
            };
        })();
    </script>
    <!-- 使用 unpkg CDN，并添加错误处理 -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" 
            onerror="console.error('Leaflet 库加载失败，请检查网络连接')"></script>
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"
            onerror="console.error('Leaflet.heat 库加载失败，请检查网络连接')"></script>
    <!-- html2canvas 已改为延迟加载，仅在需要导出时加载 -->
    <script src="js/utils.js"></script>
    <script src="js/map-config.js"></script>
    <!-- fit-file-parser 库（可选，如果文件不存在会自动降级到手动解析） -->
    <script src="js/fit-file-parser.min.js" defer></script>
    <script src="js/gpx-parser.js"></script>
    <script src="js/fit-parser.js"></script>
    <script src="js/heatmap-renderer.js"></script>
    <script src="js/video-generator.js"></script>
    <script src="js/main.js"></script>
</body>
</html>
