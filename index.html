<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🚴 骑行热力图 - GPX轨迹生成热力图</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/style.css">
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🚴</text></svg>">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <h1>🚴 骑行热力图</h1>
            <p class="subtitle">GPX轨迹生成热力图</p>
        </header>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Left Panel -->
            <div class="left-panel">
                <!-- File Upload Area -->
                <div class="upload-section">
                    <h3>📁 上传GPX文件</h3>
                    <div class="upload-area" id="uploadArea">
                        <div class="upload-content">
                            <div class="upload-icon">📁</div>
                            <p class="upload-text">拖拽GPX文件到这里</p>
                            <p class="upload-subtext">或点击选择文件</p>
                            <input type="file" id="fileInput" multiple accept=".gpx" style="display: none;">
                            <button class="upload-btn" id="selectFileBtn">
                                选择文件
                            </button>
                            <button class="help-btn" id="gpxGuideBtn" onclick="showGpxGuide()">
                                📖 如何获取GPX文件？
                            </button>
                        </div>
                    </div>
                    
                    <!-- File List -->
                    <div class="file-list" id="fileList" style="display: none;">
                        <div class="file-list-header">
                            <h4>已加载的文件:</h4>
                            <button class="clear-btn" id="clearFiles">清除所有</button>
                        </div>
                        <details class="file-dropdown">
                            <summary class="file-summary" id="fileSummary">
                                <span id="fileCountText">0 个文件</span>
                                <span class="dropdown-arrow">▼</span>
                            </summary>
                            <div class="file-dropdown-content">
                                <ul id="fileListItems"></ul>
                            </div>
                        </details>
                    </div>
                </div>

                <!-- Generate Button Section -->
                <div class="generate-section">
                    <button class="generate-btn-large" id="generateBtn" disabled>
                        🗺️ 生成热力图
                    </button>
                    <p class="generate-hint">上传GPX文件后点击生成</p>
                </div>

                <!-- Controls Panel -->
                <div class="controls-section">
                    <h3>⚙️ 参数设置</h3>
                    
                    <!-- Map Style -->
                    <div class="control-group">
                        <label for="mapStyle">地图样式:</label>
                        <select id="mapStyle">
                            <option value="dark">暗色地图 (推荐)</option>
                            <option value="light">浅色地图</option>
                        </select>
                    </div>

                    <!-- Map Language -->
                    <div class="control-group">
                        <label for="mapLanguage">地图语言:</label>
                        <select id="mapLanguage">
                            <option value="en" selected>English Map (CartoDB)</option>
                            <option value="zh-vector">中文地图 (天地图矢量)</option>
                            <option value="zh-satellite">中文卫星图 (天地图影像)</option>
                        </select>
                    </div>

                    <!-- Radius -->
                    <div class="control-group">
                        <label for="radius">线条粗细: <span id="radiusValue">1</span></label>
                        <input type="range" id="radius" min="1" max="10" value="1" step="1">
                    </div>

                    <!-- Blur -->
                    <div class="control-group">
                        <label for="blur">模糊程度: <span id="blurValue">1</span></label>
                        <input type="range" id="blur" min="1" max="20" value="1" step="1">
                    </div>

                    <!-- Opacity -->
                    <div class="control-group">
                        <label for="opacity">透明度: <span id="opacityValue">0.8</span></label>
                        <input type="range" id="opacity" min="0.1" max="1.0" value="0.8" step="0.1">
                    </div>

                    <!-- Date Range -->
                    <div class="control-group">
                        <label for="dateRange">时间范围:</label>
                        <select id="dateRange">
                            <option value="30">最近30天</option>
                            <option value="90">最近3个月</option>
                            <option value="180">最近6个月</option>
                            <option value="365" selected>最近1年</option>
                            <option value="0">所有时间</option>
                        </select>
                    </div>
                </div>

                <!-- Statistics -->
                <div class="stats-section" id="statsSection" style="display: none;">
                    <h3>📊 统计信息</h3>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <span class="stat-label">文件数量:</span>
                            <span class="stat-value" id="fileCount">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">轨迹点数:</span>
                            <span class="stat-value" id="pointCount">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">日期范围:</span>
                            <span class="stat-value" id="dateRangeText">-</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">总里程:</span>
                            <span class="stat-value" id="totalDistance">0 km</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Panel - Map -->
            <div class="right-panel">
                <div class="map-container">
                    <div id="map" class="map"></div>
                    
                    <!-- Loading Overlay -->
                    <div class="loading-overlay" id="loadingOverlay" style="display: none;">
                        <div class="loading-content">
                            <div class="spinner"></div>
                            <p id="loadingText">正在处理文件...</p>
                            <div class="progress-bar">
                                <div class="progress-fill" id="progressFill"></div>
                            </div>
                        </div>
                    </div>

                    <!-- API Usage Panel -->
                    <div class="api-usage-panel" id="apiUsagePanel">
                        <div class="usage-item">
                            <span class="usage-label">矢量底图:</span>
                            <span class="usage-count" id="vectorCount">0</span>
                            <span class="usage-limit">/ 10,000</span>
                            <div class="usage-bar">
                                <div class="usage-fill normal" id="vectorBar"></div>
                            </div>
                        </div>
                        <div class="usage-item">
                            <span class="usage-label">中文标注:</span>
                            <span class="usage-count" id="labelCount">0</span>
                            <span class="usage-limit">/ 10,000</span>
                            <div class="usage-bar">
                                <div class="usage-fill normal" id="labelBar"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Map Type Indicator -->
                    <div class="map-type-indicator english-map" id="mapTypeIndicator">
                        🇬🇧 英文地图 (CartoDB)
                    </div>

                    <!-- Map Controls -->
                    <div class="map-controls">
                        <button class="map-control-btn" id="exportBtn" title="导出为PNG" disabled>
                            📷 导出
                        </button>
                        <button class="map-control-btn" id="fullscreenBtn" title="全屏显示">
                            🔍 全屏
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="footer">
            <p>
                💡 提示: 所有文件都在浏览器本地处理，不会上传到服务器 | 
                <a href="https://dadongshangu.github.io" target="_blank">开发者</a> | 
                <a href="#" onclick="showHelp()">使用帮助</a> | 
                <a href="#" onclick="showDonate()">☕ 支持项目</a>
            </p>
        </footer>
    </div>

    <!-- Help Modal -->
    <div class="modal" id="helpModal" style="display: none;">
        <div class="modal-content">
            <span class="close" onclick="closeHelp()">&times;</span>
            <h2>📖 使用帮助</h2>
            <div class="help-content">
                <h3>🚀 快速开始</h3>
                <ol>
                    <li>拖拽或选择GPX文件上传</li>
                    <li>调整参数设置（可选）</li>
                    <li>点击"生成热力图"按钮</li>
                    <li>在地图上查看结果</li>
                </ol>

                <h3>⚙️ 参数说明</h3>
                <ul>
                    <li><strong>地图样式:</strong> 选择暗色或浅色背景</li>
                    <li><strong>线条粗细:</strong> 数值越大线条越粗</li>
                    <li><strong>模糊程度:</strong> 数值越大越模糊</li>
                    <li><strong>透明度:</strong> 热力图的透明度</li>
                    <li><strong>时间范围:</strong> 只显示指定时间内的轨迹</li>
                </ul>

                <h3>📁 支持的文件格式</h3>
                <ul>
                    <li>GPX文件 (.gpx)</li>
                    <li>支持批量上传多个文件</li>
                </ul>

                <h3>🎨 Strava风格</h3>
                <p>热力图使用绿→黄→红的渐变色，频繁经过的路线会显示为红色。</p>
            </div>
        </div>
    </div>

    <!-- GPX Guide Modal -->
    <div class="modal" id="gpxGuideModal" style="display: none;">
        <div class="modal-content large-modal">
            <span class="close" onclick="closeGpxGuide()">&times;</span>
            <h2>📖 如何获取GPX文件？</h2>
            <div class="guide-content">
                <!-- 搜索框 -->
                <div class="search-box">
                    <input type="text" id="guideSearch" placeholder="🔍 搜索你的设备或应用..." onkeyup="filterGuide()">
                </div>

                <!-- 码表设备 -->
                <div class="guide-section" data-keywords="码表 迈金 meilan igpsport garmin wahoo bryton 顽鹿竞技">
                    <h3>🚴 码表设备</h3>
                    
                    <div class="device-group">
                        <h4>🇨🇳 国产码表品牌</h4>
                        
                        <div class="device-item">
                            <h5>📱 迈金码表 (MEILAN)</h5>
                            <p><strong>对应App:</strong> 顽鹿竞技</p>
                            <ol>
                                <li>确保码表数据已通过蓝牙同步到顽鹿竞技App</li>
                                <li>打开顽鹿竞技App，进入"活动记录"</li>
                                <li>选择要导出的骑行活动</li>
                                <li>点击"分享"或"导出"按钮</li>
                                <li>选择"GPX格式"进行导出</li>
                                <li>保存到手机或直接分享到电脑</li>
                            </ol>
                        </div>

                        <div class="device-item">
                            <h5>📱 iGPSPORT码表</h5>
                            <p><strong>对应App:</strong> iGPSPORT官方App</p>
                            <ol>
                                <li>打开iGPSPORT App，同步码表数据</li>
                                <li>在"历史记录"中找到要导出的活动</li>
                                <li>点击活动详情页面</li>
                                <li>选择"导出"→"GPX格式"</li>
                                <li>也可以同步到Strava后再导出</li>
                            </ol>
                        </div>

                        <div class="device-item">
                            <h5>📱 其他国产码表</h5>
                            <ul>
                                <li><strong>猫眼(CatEye):</strong> 使用CatEye Cycling App导出</li>
                                <li><strong>速腾(XOSS):</strong> 使用XOSS App导出</li>
                                <li><strong>百锐腾(Bryton):</strong> 使用Bryton Active App导出</li>
                            </ul>
                        </div>
                    </div>

                    <div class="device-group">
                        <h4>🌍 国际品牌码表</h4>
                        
                        <div class="device-item">
                            <h5>📱 Garmin码表 (Edge系列)</h5>
                            <ol>
                                <li><strong>方法1 - Garmin Connect:</strong>
                                    <ul>
                                        <li>打开Garmin Connect网站或App</li>
                                        <li>找到要导出的活动</li>
                                        <li>点击"导出原始数据"</li>
                                        <li>选择GPX格式下载</li>
                                    </ul>
                                </li>
                                <li><strong>方法2 - USB直连:</strong>
                                    <ul>
                                        <li>用USB线连接码表到电脑</li>
                                        <li>在Garmin/Activities文件夹中找到.fit文件</li>
                                        <li>使用在线工具转换为GPX格式</li>
                                    </ul>
                                </li>
                            </ol>
                        </div>

                        <div class="device-item">
                            <h5>📱 Wahoo码表 (ELEMNT系列)</h5>
                            <ol>
                                <li>打开Wahoo ELEMNT App</li>
                                <li>在"历史记录"中选择活动</li>
                                <li>点击"分享"按钮</li>
                                <li>选择"导出GPX"</li>
                                <li>也可以同步到Strava后导出</li>
                            </ol>
                        </div>
                    </div>
                </div>

                <!-- 智能手表 -->
                <div class="guide-section" data-keywords="手表 apple watch garmin 华为 小米 运动手表">
                    <h3>⌚ 智能手表</h3>
                    
                    <div class="device-item">
                        <h5>📱 Apple Watch</h5>
                        <ol>
                            <li><strong>通过第三方App:</strong>
                                <ul>
                                    <li>使用Strava、WorkOutDoors等App记录</li>
                                    <li>在对应App中导出GPX</li>
                                </ul>
                            </li>
                            <li><strong>通过健康App:</strong>
                                <ul>
                                    <li>健康App → 浏览 → 活动</li>
                                    <li>选择"体能训练"</li>
                                    <li>导出健康数据（需要第三方工具转换）</li>
                                </ul>
                            </li>
                        </ol>
                    </div>

                    <div class="device-item">
                        <h5>📱 Garmin手表</h5>
                        <ol>
                            <li>同Garmin码表，使用Garmin Connect导出</li>
                            <li>在Garmin Connect中找到手表记录的活动</li>
                            <li>导出为GPX格式</li>
                        </ol>
                    </div>

                    <div class="device-item">
                        <h5>📱 华为/小米手表</h5>
                        <ol>
                            <li>打开对应的运动健康App</li>
                            <li>找到运动记录</li>
                            <li>查看是否有导出功能</li>
                            <li>或同步到第三方平台后导出</li>
                        </ol>
                    </div>
                </div>

                <!-- 手机应用 -->
                <div class="guide-section" data-keywords="手机 app strava 骑记 行者 咕咚 keep 顽鹿竞技">
                    <h3>📱 手机应用</h3>
                    
                    <div class="device-group">
                        <h4>🌍 国际应用</h4>
                        
                        <div class="device-item">
                            <h5>📱 Strava</h5>
                            <ol>
                                <li><strong>单个活动导出:</strong>
                                    <ul>
                                        <li>打开Strava网站</li>
                                        <li>进入活动详情页</li>
                                        <li>点击右上角"..."菜单</li>
                                        <li>选择"导出GPX"</li>
                                    </ul>
                                </li>
                                <li><strong>批量导出:</strong>
                                    <ul>
                                        <li>进入设置 → 隐私控制</li>
                                        <li>点击"下载或删除你的账户"</li>
                                        <li>请求数据导出（包含所有GPX文件）</li>
                                    </ul>
                                </li>
                            </ol>
                        </div>

                        <div class="device-item">
                            <h5>📱 Komoot / MapMyRide</h5>
                            <ol>
                                <li>登录对应网站</li>
                                <li>找到活动记录</li>
                                <li>查找导出或下载选项</li>
                                <li>选择GPX格式</li>
                            </ol>
                        </div>
                    </div>

                    <div class="device-group">
                        <h4>🇨🇳 国内应用</h4>
                        
                        <div class="device-item">
                            <h5>📱 顽鹿竞技</h5>
                            <ol>
                                <li>打开顽鹿竞技App</li>
                                <li>进入"活动记录"</li>
                                <li>选择要导出的骑行</li>
                                <li>点击"分享"或"导出"</li>
                                <li>选择GPX格式</li>
                            </ol>
                        </div>

                        <div class="device-item">
                            <h5>📱 骑记 / 行者 / 咕咚</h5>
                            <ol>
                                <li>打开对应App</li>
                                <li>找到运动记录</li>
                                <li>查看是否有"导出"或"分享"功能</li>
                                <li>部分App可能需要会员才能导出</li>
                                <li>也可以尝试同步到Strava后导出</li>
                            </ol>
                        </div>
                    </div>
                </div>

                <!-- 其他来源 -->
                <div class="guide-section" data-keywords="室内 zwift trainer 行车记录仪">
                    <h3>🏠 其他来源</h3>
                    
                    <div class="device-item">
                        <h5>📱 室内骑行台 (Zwift, TrainerRoad)</h5>
                        <ol>
                            <li>完成室内骑行后</li>
                            <li>在对应平台找到活动记录</li>
                            <li>导出为GPX格式</li>
                            <li>或同步到Strava后导出</li>
                        </ol>
                    </div>

                    <div class="device-item">
                        <h5>📱 汽车行车记录仪</h5>
                        <ol>
                            <li>部分高端行车记录仪支持GPS轨迹记录</li>
                            <li>查看设备说明书</li>
                            <li>通过配套软件导出轨迹</li>
                        </ol>
                    </div>
                </div>

                <!-- 常见问题 -->
                <div class="guide-section">
                    <h3>❓ 常见问题</h3>
                    
                    <div class="faq-item">
                        <h5>Q: 我的设备只能导出.fit文件，怎么办？</h5>
                        <p>A: 可以使用在线转换工具，如GPSies、GPS Visualizer等，将.fit文件转换为GPX格式。</p>
                    </div>

                    <div class="faq-item">
                        <h5>Q: 为什么我的App没有导出功能？</h5>
                        <p>A: 部分App可能需要付费会员才能导出，或者可以先同步到Strava等平台再导出。</p>
                    </div>

                    <div class="faq-item">
                        <h5>Q: GPX文件很大，上传很慢怎么办？</h5>
                        <p>A: 可以使用GPX编辑工具简化轨迹点，或者分批上传多个小文件。</p>
                    </div>

                    <div class="faq-item">
                        <h5>Q: 我的迈金码表应该用什么App？</h5>
                        <p>A: 迈金(MEILAN)码表对应的官方App是"顽鹿竞技"。</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Donate Modal -->
    <div class="modal" id="donateModal" style="display: none;">
        <div class="modal-content donate-modal">
            <span class="close" onclick="closeDonate()">&times;</span>
            <h2>☕ 支持项目开发</h2>
            <div class="donate-content">
                <div class="donate-intro">
                    <p>🚴‍♂️ 如果这个骑行热力图工具对您有帮助，欢迎请作者喝杯咖啡！</p>
                    <p>您的支持是项目持续发展的动力 💪</p>
                </div>
                
                <div class="donate-qr-section">
                    <h3>💝 微信赞赏</h3>
                    <div class="qr-container">
                        <img src="donate.JPEG" alt="微信赞赏码" class="donate-qr" />
                        <p class="qr-instruction">使用微信扫描上方二维码即可赞赏</p>
                    </div>
                </div>
                
                <div class="donate-thanks">
                    <p>🙏 感谢您的支持与鼓励！</p>
                    <p>每一份支持都会让这个项目变得更好 ✨</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
    <script src="https://unpkg.com/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="js/map-config.js"></script>
    <script src="js/gpx-parser.js"></script>
    <script src="js/heatmap-renderer.js"></script>
    <script src="js/main.js"></script>
</body>
</html>
