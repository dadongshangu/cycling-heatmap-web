# è‡ªåŠ¨æµ‹è¯•æŒ‡å—

## ğŸ“‹ æ¦‚è¿°

æœ¬é¡¹ç›®åŒ…å«ä¸€å¥—å®Œæ•´çš„è‡ªåŠ¨æµ‹è¯•ç³»ç»Ÿï¼Œç”¨äºåœ¨ä»£ç æäº¤å‰è‡ªåŠ¨æ£€æŸ¥ä»£ç è´¨é‡ã€è¯­æ³•é”™è¯¯å’Œæ–‡ä»¶å®Œæ•´æ€§ã€‚

## ğŸš€ å¿«é€Ÿå¼€å§‹

### è¿è¡Œæ‰€æœ‰æµ‹è¯•

```bash
# è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶ï¼ˆåŒ…æ‹¬å•å…ƒæµ‹è¯•å’Œå›å½’æµ‹è¯•ï¼‰
node scripts/test/test-all.js

# æˆ–è¿è¡ŒåŸæœ‰çš„æµ‹è¯•ï¼ˆå‘åå…¼å®¹ï¼‰
node scripts/test-all.js
```

### å•ç‹¬è¿è¡Œå„é¡¹æµ‹è¯•

```bash
# è¯­æ³•æ£€æŸ¥
node scripts/check-syntax.js

# æ–‡ä»¶å®Œæ•´æ€§æ£€æŸ¥
node scripts/check-files.js

# ä»£ç è´¨é‡æ£€æŸ¥
node scripts/check-quality.js

# å•å…ƒæµ‹è¯•
node scripts/test/unit/test-geo-utils.js
node scripts/test/unit/test-gpx-parser.js

# å›å½’æµ‹è¯•
node scripts/test/regression/test-export-regression.js
node scripts/test/regression/test-fit-regression.js
```

## ğŸ“ æµ‹è¯•å†…å®¹

### 1. è¯­æ³•æ£€æŸ¥ (`check-syntax.js`)

**æ£€æŸ¥å†…å®¹ï¼š**
- JavaScriptæ–‡ä»¶è¯­æ³•éªŒè¯ï¼ˆä½¿ç”¨ `node -c`ï¼‰
- æ‹¬å·é…å¯¹æ£€æŸ¥ï¼ˆå¤§æ‹¬å·ã€åœ†æ‹¬å·ã€æ–¹æ‹¬å·ï¼‰
- å¤„ç†å¯é€‰é“¾æ“ä½œç¬¦ï¼ˆæµè§ˆå™¨æ”¯æŒï¼Œæ—§ç‰ˆNode.jsä¸æ”¯æŒï¼‰

**æ£€æŸ¥çš„æ–‡ä»¶ï¼š**
- `js/main.js`
- `js/heatmap-renderer.js`
- `js/gpx-parser.js`
- `js/map-config.js`

**è¾“å‡ºï¼š**
- âœ… è¯­æ³•æ­£ç¡®ï¼Œæ‹¬å·é…å¯¹æ­£ç¡®
- âŒ è¯­æ³•é”™è¯¯æˆ–æ‹¬å·é…å¯¹é”™è¯¯ï¼ˆä¼šæ˜¾ç¤ºè¯¦ç»†é”™è¯¯ä¿¡æ¯ï¼‰

### 2. æ–‡ä»¶å®Œæ•´æ€§æ£€æŸ¥ (`check-files.js`)

**æ£€æŸ¥å†…å®¹ï¼š**
- å¿…éœ€æ–‡ä»¶æ˜¯å¦å­˜åœ¨
- HTMLç»“æ„å®Œæ•´æ€§ï¼ˆå¿…éœ€çš„å…ƒç´ IDï¼‰
- è„šæœ¬å¼•ç”¨æ˜¯å¦æ­£ç¡®
- HTMLåŸºæœ¬ç»“æ„ï¼ˆDOCTYPEã€htmlã€headã€bodyæ ‡ç­¾ï¼‰
- CSSæ–‡ä»¶æ˜¯å¦ä¸ºç©º

**æ£€æŸ¥çš„æ–‡ä»¶ï¼š**
- `index.html`
- `css/style.css`
- æ‰€æœ‰ JavaScript æ–‡ä»¶

**æ£€æŸ¥çš„å…ƒç´ IDï¼š**
- `map` - åœ°å›¾å®¹å™¨
- `fileInput` - æ–‡ä»¶è¾“å…¥
- `selectFileBtn` - é€‰æ‹©æ–‡ä»¶æŒ‰é’®
- `generateBtn` - ç”ŸæˆæŒ‰é’®
- `exportBtn` - å¯¼å‡ºæŒ‰é’®
- `uploadArea` - ä¸Šä¼ åŒºåŸŸ
- `clearFiles` - æ¸…é™¤æ–‡ä»¶æŒ‰é’®
- `mapStyle` - åœ°å›¾æ ·å¼é€‰æ‹©
- `mapLanguage` - åœ°å›¾è¯­è¨€é€‰æ‹©
- `dateRange` - æ—¥æœŸèŒƒå›´é€‰æ‹©
- `radius` - çº¿æ¡ç²—ç»†
- `blur` - æ¨¡ç³Šç¨‹åº¦
- `opacity` - é€æ˜åº¦

**è¾“å‡ºï¼š**
- âœ… æ‰€æœ‰æ£€æŸ¥é€šè¿‡
- âŒ å‘ç°ç¼ºå¤±çš„æ–‡ä»¶æˆ–å…ƒç´ 

### 3. ä»£ç è´¨é‡æ£€æŸ¥ (`check-quality.js`)

**æ£€æŸ¥å†…å®¹ï¼š**
- æ–‡ä»¶å¤§å°æ£€æŸ¥ï¼ˆè­¦å‘Šè¿‡å¤§æ–‡ä»¶ï¼‰
- TODO/FIXME æ³¨é‡Šæ£€æŸ¥
- è°ƒè¯•ä»£ç æ£€æŸ¥

**è¾“å‡ºï¼š**
- âœ… ä»£ç è´¨é‡æ£€æŸ¥é€šè¿‡
- âš ï¸ æœ‰è­¦å‘Šä½†å¯ä»¥ç»§ç»­ï¼ˆä¸å½±å“æäº¤ï¼‰

### 4. å•å…ƒæµ‹è¯• (`scripts/test/unit/`)

**æµ‹è¯•å†…å®¹ï¼š**
- **GeoUtilsæµ‹è¯•** (`test-geo-utils.js`) - æµ‹è¯•åœ°ç†è®¡ç®—å·¥å…·å‡½æ•°
  - `toRadians` å‡½æ•°æµ‹è¯•
  - `haversineDistance` å‡½æ•°æµ‹è¯•
  - è·ç¦»è®¡ç®—å‡†ç¡®æ€§éªŒè¯
- **GPXè§£æå™¨æµ‹è¯•** (`test-gpx-parser.js`) - æµ‹è¯•GPXæ–‡ä»¶è§£æ
  - æ–‡ä»¶è§£æåŠŸèƒ½
  - è½¨è¿¹ç‚¹æå–
  - åæ ‡éªŒè¯
  - è·ç¦»è®¡ç®—

**è¿è¡Œæ–¹å¼ï¼š**
```bash
node scripts/test/unit/test-geo-utils.js
node scripts/test/unit/test-gpx-parser.js
```

### 5. å›å½’æµ‹è¯• (`scripts/test/regression/`)

**æµ‹è¯•å†…å®¹ï¼š**
- **å¯¼å‡ºåŠŸèƒ½å›å½’æµ‹è¯•** (`test-export-regression.js`) - ç¡®ä¿å¯¼å‡ºåŠŸèƒ½ä¸ä¼šå†æ¬¡å‡ºç°é—®é¢˜
  - æ£€æŸ¥ `exportMapAsImage` ç›´æ¥ä½¿ç”¨ `html2canvas`ï¼ˆä¸è°ƒç”¨ `loadHtml2Canvas`ï¼‰
  - éªŒè¯ç§»åŠ¨ç«¯é…ç½®æ­£ç¡®ï¼ˆ`imageTimeout = 12000`ï¼Œæ—  `ignoreElements`ï¼‰
  - éªŒè¯PCç«¯é…ç½®ç®€åŒ–ï¼ˆåªæœ‰åŸºæœ¬é…ç½®ï¼‰
  - éªŒè¯ç§»åŠ¨ç«¯å¯¼å‡ºæµç¨‹ï¼ˆWeb Shareå¤±è´¥åç›´æ¥æ˜¾ç¤ºæ¨¡æ€æ¡†ï¼‰
- **FITè§£æå›å½’æµ‹è¯•** (`test-fit-regression.js`) - ç¡®ä¿FITåæ ‡è½¬æ¢ä¸ä¼šå†æ¬¡å‡ºç°é—®é¢˜
  - æ£€æŸ¥ `semicirclesToDegrees` å‡½æ•°å­˜åœ¨
  - éªŒè¯åæ ‡è½¬æ¢å…¬å¼æ­£ç¡®
  - éªŒè¯åæ ‡æ ¼å¼æ£€æµ‹é€»è¾‘å­˜åœ¨
  - éªŒè¯ç¦»ç¾¤ç‚¹è¿‡æ»¤é€»è¾‘å­˜åœ¨

**è¿è¡Œæ–¹å¼ï¼š**
```bash
node scripts/test/regression/test-export-regression.js
node scripts/test/regression/test-fit-regression.js
```

**é‡è¦æ€§ï¼š**
è¿™äº›å›å½’æµ‹è¯•ç¡®ä¿ä¹‹å‰ä¿®å¤çš„é—®é¢˜ä¸ä¼šå†æ¬¡å‡ºç°ï¼Œæ˜¯é˜²æ­¢åŠŸèƒ½é€€åŒ–çš„å…³é”®æµ‹è¯•ã€‚

## ğŸ”§ Git Hooks

### Pre-commit Hookï¼ˆå¿«é€Ÿæµ‹è¯•ï¼‰

é¡¹ç›®å·²é…ç½® Git pre-commit hookï¼Œæ¯æ¬¡æäº¤å‰ä¼šè‡ªåŠ¨è¿è¡Œå¿«é€Ÿæµ‹è¯•ã€‚

**å·¥ä½œåŸç†ï¼š**
1. æ‰§è¡Œ `git commit` æ—¶è‡ªåŠ¨è§¦å‘
2. è¿è¡Œå¿«é€Ÿæµ‹è¯•å¥—ä»¶ï¼ˆè¯­æ³•æ£€æŸ¥ã€æ–‡ä»¶å®Œæ•´æ€§ã€å•å…ƒæµ‹è¯•ã€å›å½’æµ‹è¯•ï¼‰
3. å¦‚æœæµ‹è¯•å¤±è´¥ï¼Œé˜»æ­¢æäº¤
4. å¦‚æœæµ‹è¯•é€šè¿‡ï¼Œå…è®¸æäº¤

**æµ‹è¯•å†…å®¹ï¼š**
- è¯­æ³•æ£€æŸ¥
- æ–‡ä»¶å®Œæ•´æ€§æ£€æŸ¥
- GeoUtilså•å…ƒæµ‹è¯•
- å¯¼å‡ºåŠŸèƒ½å›å½’æµ‹è¯•
- FITè§£æå›å½’æµ‹è¯•

**è®¾ç½®Hookï¼ˆWindowsï¼‰ï¼š**
```bash
# å¤åˆ¶pre-commit hook
copy scripts\pre-commit-fast-test.bat .git\hooks\pre-commit
```

**è®¾ç½®Hookï¼ˆLinux/Macï¼‰ï¼š**
```bash
# å¤åˆ¶pre-commit hook
cp scripts/pre-commit-fast-test.sh .git/hooks/pre-commit
chmod +x .git/hooks/pre-commit
```

### Pre-push Hookï¼ˆå®Œæ•´æµ‹è¯•ï¼‰

å¯é€‰é…ç½® pre-push hookï¼Œåœ¨æ¨é€å‰è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶ã€‚

**è®¾ç½®Hookï¼ˆWindowsï¼‰ï¼š**
```bash
copy scripts\pre-push-full-test.bat .git\hooks\pre-push
```

**è®¾ç½®Hookï¼ˆLinux/Macï¼‰ï¼š**
```bash
cp scripts/pre-push-full-test.sh .git/hooks/pre-push
chmod +x .git/hooks/pre-push
```

### æ‰‹åŠ¨è¿è¡Œï¼ˆæµ‹è¯•Hookï¼‰

```bash
# åœ¨é¡¹ç›®æ ¹ç›®å½•
node scripts/test-all.js
```

### è·³è¿‡Hookï¼ˆä¸æ¨èï¼‰

å¦‚æœç¡®å®éœ€è¦è·³è¿‡æµ‹è¯•ï¼ˆä¸æ¨èï¼‰ï¼Œå¯ä»¥ä½¿ç”¨ï¼š

```bash
git commit --no-verify -m "Your message"
```

**âš ï¸ è­¦å‘Šï¼š** åªæœ‰åœ¨ç´§æ€¥æƒ…å†µä¸‹æ‰åº”è¯¥è·³è¿‡æµ‹è¯•ã€‚

## ğŸ“Š æµ‹è¯•æŠ¥å‘Š

è¿è¡Œ `test-all.js` ä¼šç”Ÿæˆè¯¦ç»†çš„æµ‹è¯•æŠ¥å‘Šï¼š

```
ğŸš€ å¼€å§‹è¿è¡Œæ‰€æœ‰æµ‹è¯•...

============================================================
ğŸ“‹ æµ‹è¯• 1/3: è¯­æ³•æ£€æŸ¥
...
============================================================
ğŸ“‹ æµ‹è¯• 2/3: æ–‡ä»¶å®Œæ•´æ€§æ£€æŸ¥
...
============================================================
ğŸ“‹ æµ‹è¯• 3/3: ä»£ç è´¨é‡æ£€æŸ¥
...
============================================================
ğŸ“Š æµ‹è¯•ç»“æœæ±‡æ€»
============================================================
âœ… é€šè¿‡ è¯­æ³•æ£€æŸ¥
âœ… é€šè¿‡ æ–‡ä»¶å®Œæ•´æ€§
âœ… é€šè¿‡ ä»£ç è´¨é‡
============================================================
âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼å¯ä»¥å®‰å…¨æäº¤ä»£ç ã€‚
```

## ğŸ› ï¸ æ•…éšœæ’é™¤

### é—®é¢˜1: è¯­æ³•æ£€æŸ¥å¤±è´¥ï¼ˆå¯é€‰é“¾æ“ä½œç¬¦ï¼‰

**é”™è¯¯ä¿¡æ¯ï¼š**
```
SyntaxError: Unexpected token '.'
```

**åŸå› ï¼š** Node.js ç‰ˆæœ¬ < 14 ä¸æ”¯æŒå¯é€‰é“¾æ“ä½œç¬¦ `?.`

**è§£å†³æ–¹æ¡ˆï¼š**
- ä»£ç åœ¨æµè§ˆå™¨ä¸­è¿è¡Œï¼Œæµè§ˆå™¨æ”¯æŒå¯é€‰é“¾
- æµ‹è¯•è„šæœ¬å·²è‡ªåŠ¨å¤„ç†è¿™ç§æƒ…å†µ
- å¦‚æœä»ç„¶å¤±è´¥ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»–è¯­æ³•é”™è¯¯

### é—®é¢˜2: æ–‡ä»¶å®Œæ•´æ€§æ£€æŸ¥å¤±è´¥

**å¯èƒ½åŸå› ï¼š**
- æ–‡ä»¶è¢«åˆ é™¤æˆ–ç§»åŠ¨
- HTMLç»“æ„è¢«ä¿®æ”¹
- å…ƒç´ IDè¢«æ›´æ”¹

**è§£å†³æ–¹æ¡ˆï¼š**
- æ£€æŸ¥é”™è¯¯ä¿¡æ¯ä¸­æåˆ°çš„æ–‡ä»¶æˆ–å…ƒç´ 
- ç¡®ä¿æ‰€æœ‰å¿…éœ€æ–‡ä»¶å­˜åœ¨
- ç¡®ä¿HTMLä¸­åŒ…å«æ‰€æœ‰å¿…éœ€çš„å…ƒç´ ID

### é—®é¢˜3: Git Hook ä¸å·¥ä½œ

**Windowsç”¨æˆ·ï¼š**
- Git Bash: Hookåº”è¯¥è‡ªåŠ¨å·¥ä½œ
- PowerShell/CMD: å¯èƒ½éœ€è¦é…ç½®Gitä½¿ç”¨bashæ‰§è¡Œhooks
- æ£€æŸ¥ `.git/hooks/pre-commit` æ–‡ä»¶æ˜¯å¦å­˜åœ¨
- å¦‚æœhookä¸å·¥ä½œï¼Œå¯ä»¥æ‰‹åŠ¨è¿è¡Œ `node scripts/test-all.js` åå†æäº¤

**Linux/Macç”¨æˆ·ï¼š**
```bash
chmod +x .git/hooks/pre-commit
```

**éªŒè¯Hookæ˜¯å¦å·¥ä½œï¼š**
```bash
# å°è¯•æäº¤ä¸€ä¸ªæµ‹è¯•æ›´æ”¹
git commit --allow-empty -m "Test commit"
# å¦‚æœçœ‹åˆ°æµ‹è¯•è¾“å‡ºï¼Œè¯´æ˜hookæ­£å¸¸å·¥ä½œ
```

## ğŸ“š æœ€ä½³å®è·µ

### æäº¤å‰æ£€æŸ¥æ¸…å•

- [ ] è¿è¡Œ `node scripts/test-all.js` ç¡®ä¿æ‰€æœ‰æµ‹è¯•é€šè¿‡
- [ ] åœ¨æµè§ˆå™¨ä¸­å®é™…æµ‹è¯•åŠŸèƒ½
- [ ] æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°æ²¡æœ‰é”™è¯¯
- [ ] éªŒè¯æ ¸å¿ƒåŠŸèƒ½æ­£å¸¸å·¥ä½œ

### å¼€å‘å·¥ä½œæµ

1. **ä¿®æ”¹ä»£ç **
2. **è¿è¡Œæµ‹è¯•** - `node scripts/test-all.js`
3. **ä¿®å¤é”™è¯¯** - æ ¹æ®æµ‹è¯•æŠ¥å‘Šä¿®å¤é—®é¢˜
4. **å†æ¬¡æµ‹è¯•** - ç¡®ä¿æ‰€æœ‰æµ‹è¯•é€šè¿‡
5. **æäº¤ä»£ç ** - `git commit`ï¼ˆè‡ªåŠ¨è¿è¡Œæµ‹è¯•ï¼‰

## ğŸ”„ æŒç»­æ”¹è¿›

### å·²å®Œæˆ

- [x] æ·»åŠ å•å…ƒæµ‹è¯•ï¼ˆGeoUtilsã€GPXè§£æå™¨ï¼‰
- [x] æ·»åŠ å›å½’æµ‹è¯•ï¼ˆå¯¼å‡ºåŠŸèƒ½ã€FITè§£æï¼‰
- [x] åˆ›å»ºæµ‹è¯•æ¡†æ¶å’Œæµ‹è¯•è¿è¡Œå™¨
- [x] é›†æˆåˆ°Git Hook

### æœªæ¥è®¡åˆ’

- [ ] æ·»åŠ æµè§ˆå™¨è‡ªåŠ¨åŒ–æµ‹è¯•ï¼ˆPuppeteer/Playwrightï¼‰
- [ ] æ·»åŠ é›†æˆæµ‹è¯•ï¼ˆç«¯åˆ°ç«¯æµç¨‹æµ‹è¯•ï¼‰
- [ ] é›†æˆåˆ° CI/CD æµç¨‹ï¼ˆGitHub Actionsï¼‰
- [ ] æ·»åŠ æµ‹è¯•è¦†ç›–ç‡ç»Ÿè®¡

## ğŸ“ æ”¯æŒ

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·ï¼š
- æŸ¥çœ‹ `doc/BUG_ANALYSIS_AND_PREVENTION.md` äº†è§£å¸¸è§é—®é¢˜
- æäº¤ Issue åˆ° GitHub ä»“åº“

---

## ğŸ“‹ æµ‹è¯•æ¡†æ¶è¯´æ˜

### æµ‹è¯•è¿è¡Œå™¨ (`scripts/test/utils/test-runner.js`)

è‡ªå®šä¹‰çš„è½»é‡çº§æµ‹è¯•æ¡†æ¶ï¼Œæä¾›ï¼š
- `test(name, fn)` - æ³¨å†Œæµ‹è¯•ç”¨ä¾‹
- `assert(condition, message)` - åŸºæœ¬æ–­è¨€
- `assertEqual(actual, expected, message)` - ç›¸ç­‰æ–­è¨€
- `assertAlmostEqual(actual, expected, tolerance, message)` - è¿‘ä¼¼ç›¸ç­‰æ–­è¨€ï¼ˆç”¨äºæµ®ç‚¹æ•°ï¼‰
- `assertInRange(value, min, max, message)` - èŒƒå›´æ–­è¨€
- `assertNotEmpty(value, message)` - éç©ºæ–­è¨€

### æµ‹è¯•æ–‡ä»¶ç»“æ„

```
scripts/test/
  unit/              # å•å…ƒæµ‹è¯•
    test-geo-utils.js
    test-gpx-parser.js
  regression/        # å›å½’æµ‹è¯•
    test-export-regression.js
    test-fit-regression.js
  fixtures/          # æµ‹è¯•æ•°æ®
    sample.gpx
  utils/             # æµ‹è¯•å·¥å…·
    test-runner.js
  test-all.js        # è¿è¡Œæ‰€æœ‰æµ‹è¯•
```

### ç¼–å†™æ–°æµ‹è¯•

1. åœ¨ç›¸åº”çš„æµ‹è¯•ç›®å½•åˆ›å»ºæµ‹è¯•æ–‡ä»¶
2. å¼•å…¥æµ‹è¯•è¿è¡Œå™¨ï¼š`const TestRunner = require('../utils/test-runner')`
3. åˆ›å»ºæµ‹è¯•å®ä¾‹ï¼š`const runner = new TestRunner()`
4. ç¼–å†™æµ‹è¯•ç”¨ä¾‹ï¼š`runner.test('æµ‹è¯•åç§°', () => { ... })`
5. è¿è¡Œæµ‹è¯•ï¼š`runner.run()`

**ç¤ºä¾‹ï¼š**
```javascript
const TestRunner = require('../utils/test-runner');
const runner = new TestRunner();

runner.test('æˆ‘çš„æµ‹è¯•', () => {
    const result = myFunction();
    runner.assertEqual(result, expected, 'ç»“æœåº”è¯¥ç­‰äºæœŸæœ›å€¼');
});

if (require.main === module) {
    runner.run().then(success => {
        process.exit(success ? 0 : 1);
    });
}
```

---

*æœ€åæ›´æ–°ï¼š2026å¹´1æœˆï¼ˆæ·»åŠ å•å…ƒæµ‹è¯•å’Œå›å½’æµ‹è¯•ï¼‰*
